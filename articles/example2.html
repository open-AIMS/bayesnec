<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi model usage • bayesnec</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Multi model usage">
<meta property="og:description" content="bayesnec">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bayesnec</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example1.html">Single model usage</a>
    </li>
    <li>
      <a href="../articles/example2.html">Multi model usage</a>
    </li>
    <li>
      <a href="../articles/example2b.html">Model details</a>
    </li>
    <li>
      <a href="../articles/example3.html">Priors</a>
    </li>
    <li>
      <a href="../articles/example4.html">Comparing posterior predictions</a>
    </li>
    <li>
      <a href="../articles/example5.html">Running `bayesnec`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/open-aims/bayesnec/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Multi model usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/open-aims/bayesnec/blob/HEAD/vignettes/example2.Rmd" class="external-link"><code>vignettes/example2.Rmd</code></a></small>
      <div class="hidden name"><code>example2.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="bayesnec">
<code>bayesnec</code><a class="anchor" aria-label="anchor" href="#bayesnec"></a>
</h2>
<p>The background of <code>bayesnec</code> is covered in the <a href="https://open-aims.github.io/bayesnec/articles/example1.html" class="external-link">Single
model usage</a> vignette. Here we explain multi model usage using
<code>bayesnec</code>. In <code>bayesnec</code> it is possible to fit a
custom model set, specific model set, or all of the available models.
When multiple models are specified the <code>bnec</code> function
returns a model weighted estimate of predicted posterior values, based
on the <code>"pseudobma"</code> using Bayesian bootstrap through
<code>loo_model_weights</code> <span class="citation">(Vehtari et al.
2020; Vehtari, Gelman, and Gabry 2017)</span>. These are reasonably
analogous to the way model weights are generated using AIC or AICc <span class="citation">(Burnham and Anderson 2002)</span>.</p>
<p>It is also possible to obtain all individual model fits from the
fitted <code>bayesnecfit</code> model object if required using the
<code>pull_out</code> function, and also to update an existing model fit
with additional models, or to drop models using the function
<code>amend</code>.</p>
<p>Multi-model inference can be useful where there are a range of
plausible models that could be used <span class="citation">(Burnham and
Anderson 2002)</span> and has been recently adopted in ecotoxicology for
Species Sensitivity Distribution (SSD) model inference <span class="citation">(Thorley and Schwarz 2018)</span>. The approach may
have considerable value in concentration-response modelling because
there is often no <em>a priori</em> knowledge of the functional form
that the response relationship should take. In this case model averaging
can be a useful way of allowing the data to drive the model selection
process, with weights proportional to how well the individual models
fits the data. Well-fitting models will have high weights, dominating
the model averaged outcome. Conversely, poorly fitting models will have
very low model weights and will therefore have little influence on the
outcome. Where multiple models fit the data equally well, these can
equally influence the outcome, and the resultant posterior predictions
reflect that model uncertainty. It is possible to specify the
<code>"stacking"</code> method <span class="citation">(Yao et al.
2018)</span> for model weights if desired (through the argument
<code>loo_controls</code>) which aims to minimise prediction error. We
do not currently recommend using stacking weights given the typical
sample sizes associated with most concentration—response experiments,
and because the main motivation for model averaging within the
<code>bayesnec</code> package is to properly capture model uncertainty
rather than reduce prediction error.</p>
</div>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<div class="section level3">
<h3 id="fitting-multiple-models-and-model-averaging-using-the-bnec-function">Fitting multiple models and model averaging using the
<code>bnec</code> function<a class="anchor" aria-label="anchor" href="#fitting-multiple-models-and-model-averaging-using-the-bnec-function"></a>
</h3>
<div class="section level4">
<h4 id="fitting-a-bnec-model">Fitting a <code>bnec</code> model<a class="anchor" aria-label="anchor" href="#fitting-a-bnec-model"></a>
</h4>
<p>So far we have explored how to fit individual models via the function
<code>bnec</code>. The <code>bayesnec</code> package also has the
capacity to fit a custom selection of models, pre-specified sets of
models, or even all the available models in the package. Note that as
these are Bayesian methods requiring multiple Hamiltonian Monte Carlo
(HMC) chains, using <code>bnec</code> can be very slow when specifying
<code>models = "all"</code> within a <code>bayesnecformula</code>. See
details under <code><a href="../reference/bnec.html">?bnec</a></code> for more information on the models, and
model sets that can be specified, as well as the <a href="https://open-aims.github.io/bayesnec/articles/example2b.html" class="external-link">Model
details</a> vignette which contains considerable information on the
available models in <code>bnec</code> and their appropriate usage. In
general it is safe to call <code>models = "all"</code>, because by
default <code>bnec</code> will discard invalid models and the model
averaging approach should result in an overall fit that reflects the
models that best fit the data. However, because the HMC can be slow for
<code>models = "all"</code> we do recommend testing your fit using a
single (likely) model in the first instance, to make sure there are no
issues with dispersion, the appropriate distribution is selected and
model fitting appears robust (see the <a href="https://open-aims.github.io/bayesnec/articles/example1.html" class="external-link">Single
model usage vignette</a> for more details).</p>
<p>To run this vignette, we will need the <code>ggplot2</code>
package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://open-aims.github.io/bayesnec/" class="external-link">bayesnec</a></span><span class="op">)</span></span>
<span><span class="co"># function which generates an "ecx4param" model</span></span>
<span><span class="va">make_ecx_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">top</span>, <span class="va">bot</span>, <span class="va">ec50</span>, <span class="va">beta</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">top</span> <span class="op">+</span> <span class="op">(</span><span class="va">bot</span> <span class="op">-</span> <span class="va">top</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">ec50</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, length <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">make_ecx_data</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, bot <span class="op">=</span> <span class="fl">0</span>, top <span class="op">=</span> <span class="fl">1</span>, beta <span class="op">=</span> <span class="fl">0.5</span>, ec50 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">333</span><span class="op">)</span></span>
<span><span class="va">df_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">15</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">y</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exp_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bnec.html">bnec</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">crf</span><span class="op">(</span><span class="va">x</span>, model <span class="op">=</span> <span class="st">"decline"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_</span>, iter <span class="op">=</span> <span class="fl">2e3</span><span class="op">)</span></span></code></pre></div>
<p>Here we run <code>bnec</code> using <code>model =  "decline"</code>
using a simulated data example for a Beta-distributed response variable.
We are using the <code>"decline"</code> set here because we are not
going to consider hormesis (these allow an initial increase in the
response), largely to save time in fitting this example. Moreover, you
might want to consider saving the output as an <code>.RData</code>
file—doing so can be a useful way of fitting large model sets (ie
<code>model = "all"</code>, or <code>model = "decline"</code>) at a
convenient time (this can be very slow, and may be run overnight for
example) so you can reload them later to explore, plot, extract values,
and amend the model set as required.</p>
<p>Whenever the <code>model</code> argument of <code>crf</code> is a
model set, or a concatenation of specific models, <code>bnec</code> will
return an object of class <code>bayesmanecfit</code>.</p>
</div>
<div class="section level4">
<h4 id="exploring-a-bayesmanecfit-model">Exploring a <code>bayesmanecfit</code> model<a class="anchor" aria-label="anchor" href="#exploring-a-bayesmanecfit-model"></a>
</h4>
<p>We have created some plotting method functions for both the
<code>bayesnecfit</code> and <code>bayesmanecfit</code> model fits, so
we can plot a <code>bayesmanecfit</code> model object simply with
<code>autoplot</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">exp_5</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="vignette-fig-exmp2-decline-1.png" alt="plot of chunk exmp2-decline" width="60%"><p class="caption">
plot of chunk exmp2-decline
</p>
</div>
<p>The default plot looks exactly the same as our regular
<code>bayesnecfit</code> plot, but the output is based on a weighted
average of all the model fits in the <code>model = "decline"</code>
model set that were able to fit successfully using the default
<code>bnec</code> settings. The <em>NEC</em> estimate on this plot (and
in the summary output below) is based on a mix of actual <em>NEC</em>
estimates, as well as the <em>NSEC</em> <span class="citation">(Fisher
and Fox, n.d.)</span> estimates that are used as an approximation to
<em>NEC</em> for all the <strong>ecx</strong>-containing models in the
set. The fitted <code>bayesmanecfit</code> object contains different
elements to the <code>bayesnecfit</code>. In particular,
<code>mod_stats</code> contains the table of model fit statistics for
all the fitted models. This includes the model name, the WAIC (as
returned from <code>brms</code>), wi (the model weight, currently
defaulting to <code>"pseudobma"</code> using Bayesian bootstrap from
<code>loo</code>), and the dispersion estimates (only reported if
response is modelled with a Poisson or Binomial distribution, otherwise
NA).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exp_5</span><span class="op">$</span><span class="va">mod_stats</span></span>
<span><span class="co">#&gt;               model      waic           wi dispersion_Estimate dispersion_Q2.5 dispersion_Q97.5</span></span>
<span><span class="co">#&gt; nec4param nec4param -84.52493 3.403122e-01                  NA              NA               NA</span></span>
<span><span class="co">#&gt; neclin       neclin -52.40717 4.982417e-04                  NA              NA               NA</span></span>
<span><span class="co">#&gt; ecxlin       ecxlin -27.77174 2.571332e-07                  NA              NA               NA</span></span>
<span><span class="co">#&gt; ecx4param ecx4param -82.09029 1.228082e-01                  NA              NA               NA</span></span>
<span><span class="co">#&gt; ecxwb1       ecxwb1 -75.38960 1.470637e-02                  NA              NA               NA</span></span>
<span><span class="co">#&gt; ecxwb2       ecxwb2 -84.82635 2.754053e-01                  NA              NA               NA</span></span>
<span><span class="co">#&gt; ecxll5       ecxll5 -83.78197 1.561911e-01                  NA              NA               NA</span></span>
<span><span class="co">#&gt; ecxll4       ecxll4 -81.47512 9.007833e-02                  NA              NA               NA</span></span></code></pre></div>
<p>We can obtain a neater summary of the model fit by using the
<code>summary</code> method for a <code>bayesmanecfit</code> object. A
list of fitted models, and model weights are provided. In addition, the
model averaged <em>NEC</em> is reported, however a warning is provided
indicating it contains <em>NSEC</em> values. For this example all the
nec4param and ecxwb2 models have the highest weights.</p>
<p>All these model fits are satisfactory despite the relatively low
number of iterations set in our example, but the summary would also
include a warning if there were fits with divergent transitions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/summary.html">summary</a></span><span class="op">(</span><span class="va">exp_5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Object of class bayesmanecfit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Family: gaussian  </span></span>
<span><span class="co">#&gt;   Links: mu = identity; sigma = identity  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of posterior draws per model:  1600</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model weights (Method: pseudobma_bb_weights):</span></span>
<span><span class="co">#&gt;             waic   wi</span></span>
<span><span class="co">#&gt; nec4param -84.52 0.34</span></span>
<span><span class="co">#&gt; neclin    -52.41 0.00</span></span>
<span><span class="co">#&gt; ecxlin    -27.77 0.00</span></span>
<span><span class="co">#&gt; ecx4param -82.09 0.12</span></span>
<span><span class="co">#&gt; ecxwb1    -75.39 0.01</span></span>
<span><span class="co">#&gt; ecxwb2    -84.83 0.28</span></span>
<span><span class="co">#&gt; ecxll5    -83.78 0.16</span></span>
<span><span class="co">#&gt; ecxll4    -81.48 0.09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of weighted NEC posterior estimates:</span></span>
<span><span class="co">#&gt; NB: Model set contains the ECX models: ecxlin;ecx4param;ecxwb1;ecxwb2;ecxll5;ecxll4; weighted NEC estimates include NSEC surrogates for NEC</span></span>
<span><span class="co">#&gt;     Estimate Q2.5 Q97.5</span></span>
<span><span class="co">#&gt; NEC     3.32 2.00  3.97</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bayesian R2 estimates:</span></span>
<span><span class="co">#&gt;           Estimate Est.Error Q2.5 Q97.5</span></span>
<span><span class="co">#&gt; nec4param     0.86      0.01 0.84  0.87</span></span>
<span><span class="co">#&gt; neclin        0.83      0.01 0.80  0.84</span></span>
<span><span class="co">#&gt; ecxlin        0.80      0.01 0.77  0.82</span></span>
<span><span class="co">#&gt; ecx4param     0.85      0.01 0.84  0.87</span></span>
<span><span class="co">#&gt; ecxwb1        0.85      0.01 0.83  0.86</span></span>
<span><span class="co">#&gt; ecxwb2        0.86      0.01 0.84  0.87</span></span>
<span><span class="co">#&gt; ecxll5        0.86      0.01 0.84  0.87</span></span>
<span><span class="co">#&gt; ecxll4        0.85      0.01 0.84  0.87</span></span></code></pre></div>
<p>The <code>bayesmanecfit</code> object also contains all of the
individual <code>brms</code> model fits, which can be extracted using
the <code>pull_out</code> function. For example, we can pull out and
plot the model <strong>ecx4param</strong>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exp_5_nec4param</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pull_out.html">pull_out</a></span><span class="op">(</span><span class="va">exp_5</span>, model <span class="op">=</span> <span class="st">"ecx4param"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">exp_5_nec4param</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="vignette-fig-exmp2-ecx4param-1.png" alt="plot of chunk exmp2-ecx4param" width="60%"><p class="caption">
plot of chunk exmp2-ecx4param
</p>
</div>
<p>This would extract the <strong>nec4param</strong> model from the
<code>bayesmanecfit</code> and create a new object of class
<code>bayesnecfit</code> which contains just a single fit. This would be
identical to fitting the <strong>ecx4param</strong> as a single model
using <code>bnec</code>. All of the models in the
<code>bayesmanecfit</code> can be simultaneously plotted using the
argument <code>all_models = TRUE</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">exp_5</span>, all_models <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="vignette-fig-exmp2-allmods-1.png" alt="plot of chunk exmp2-allmods" width="60%"><p class="caption">
plot of chunk exmp2-allmods
</p>
</div>
<p>You can see that some of these models represent very bad fits, and
accordingly have extremely low model weights, such as the
<strong>ecxlin</strong> and <strong>neclin</strong> models in this
example. There is no harm in leaving in poor models with low weight,
precisely because they have such a low model weight and therefore will
not influence posterior predictions. However, it is important to assess
the adequacy of model fits of all models, because a poor fit may be more
to do with a model that has not converged.</p>
<p>We can assess the chains for one of the higher weighted models to
make sure they show good convergence. It is good practice to do this for
all models with a high weight, as these are the models most influencing
the multi-model inference.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/pull_brmsfit.html">pull_brmsfit</a></span><span class="op">(</span><span class="va">exp_5</span>, <span class="st">"ecxwb1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="vignette-fig-exmp2-goodmod-1.png" alt="plot of chunk exmp2-goodmod" width="60%"><p class="caption">
plot of chunk exmp2-goodmod
</p>
</div>
<p>Assessing chains for all the models in <code>bayesmanecfit</code>
does not work as well using the default <code>brms</code> plotting
method. Instead use <code>check_chains</code> and make sure to pass a
<code>filename</code> argument, which means plots are automatically
saved to pdf with a message.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_chains.html">check_chains</a></span><span class="op">(</span><span class="va">exp_5</span>, filename <span class="op">=</span> <span class="st">"example_5_all_chains"</span><span class="op">)</span></span></code></pre></div>
<p>We can also make a plot to compare the posterior probability density
to that of the prior using the <code>check_priors</code> function, for
an individual model fit, but also saving all fits to a file in the
working directory.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_priors.html">check_priors</a></span><span class="op">(</span><span class="fu"><a href="../reference/pull_out.html">pull_out</a></span><span class="op">(</span><span class="va">exp_5</span>, <span class="st">"nec4param"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="vignette-fig-exmp2-checkpriors-1.png" alt="plot of chunk exmp2-checkpriors" width="60%"><p class="caption">
plot of chunk exmp2-checkpriors
</p>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_priors.html">check_priors</a></span><span class="op">(</span><span class="va">exp_5</span>, filename <span class="op">=</span> <span class="st">"example_5_all_priors"</span><span class="op">)</span></span></code></pre></div>
<p>Where a large number of models are failing to converge, obviously it
would be better to adjust <code>iter</code> and <code>warmup</code> in
the <code>bnec</code> call, as well as some of the other arguments to
<code>brms</code> such as <code>adapt_delta</code>. See the
<code><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">?brm</a></code> documentation for more details. It is possible to
investigate if models from a <code>bayesmanecfit</code> class achieved
convergence according to Rhat:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rhat.html">rhat</a></span><span class="op">(</span><span class="va">exp_5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="st">"[["</span>, <span class="st">"failed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; nec4param    neclin    ecxlin ecx4param    ecxwb1    ecxwb2    ecxll5    ecxll4 </span></span>
<span><span class="co">#&gt;     FALSE     FALSE     FALSE     FALSE     FALSE     FALSE     FALSE     FALSE</span></span></code></pre></div>
<p>Here we get a message because none of our models failed the default
Rhat criterion. A more conservative cut off of 1.01 can also be used by
changing the default argument to the desired value. In this case two
models fail, although we note that this is a very stringent criterion,
and we have also used less than the default <code>bayesnec</code> value
of <code>iter</code> (10,000).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rhat.html">rhat</a></span><span class="op">(</span><span class="va">exp_5</span>, rhat_cutoff <span class="op">=</span> <span class="fl">1.01</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="st">"[["</span>, <span class="st">"failed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; nec4param    neclin    ecxlin ecx4param    ecxwb1    ecxwb2    ecxll5    ecxll4 </span></span>
<span><span class="co">#&gt;      TRUE     FALSE     FALSE     FALSE     FALSE     FALSE      TRUE     FALSE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extracting-toxicity-values">Extracting toxicity values<a class="anchor" aria-label="anchor" href="#extracting-toxicity-values"></a>
</h4>
<p>The models prefixed with <strong>ecx</strong> are all models that do
not have the <em>NEC</em> as a parameter in the model. That is, they are
smooth curves as a function of concentration and have no breakpoint. The
<em>NEC</em> on the plots above for these models are an approximation
based on <em>NSEC</em> <span class="citation">(Fisher and Fox,
n.d.)</span> and should only be used with careful consideration of the
validity of this toxicity value (see the <a href="https://open-aims.github.io/bayesnec/articles/example2b.html" class="external-link">Model
details</a> vignette for more details). If a true model averaged
estimate of <em>NEC</em> based only on threshold models is desired, this
can be obtained with <code>model = "nec"</code>. We can use the helper
functions <code>pull_out</code> and <code>amend</code> to alter the
model set as required. <code>pull_out</code> has a <code>model</code>
argument and can be used to pull a single model out (as above) or to
pull out a specific set of models.</p>
<p>We can use this to obtain first a set of <em>NEC</em> only models
from the existing set.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exp_5_nec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pull_out.html">pull_out</a></span><span class="op">(</span><span class="va">exp_5</span>, model <span class="op">=</span> <span class="st">"nec"</span><span class="op">)</span></span></code></pre></div>
<p>In this case, because we have already fitted <code>"decline"</code>
models, we can ignore the message regarding the missing <em>NEC</em>
models—these are all models that are not appropriate for a
<code>Beta</code> family with a <code>logit</code> link function, or
allow hormesis, which we did not consider in this example.</p>
<p>Now we have two model sets, an <em>NEC</em> set, and a mixed
<em>NEC</em> and <em>ECx</em> set. Of course, before we use this model
set for any inference, we would need to check the chain mixing and
<code>acf</code> plot for each of the input models. For the “all” set,
the model with the highest weight is <strong>nec4param</strong>.</p>
<p>Now we can use the <code>ecx</code> function to get
<em>EC<sub>10</sub></em> and <em>EC<sub>50</sub></em> values. We can do
this using our all model set, because it is valid to use <em>NEC</em>
models for estimating <em>ECx</em> (see more information in the <a href="https://open-aims.github.io/bayesnec/articles/example2b.html" class="external-link">Model
details</a> vignette).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ECx10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ecx.html">ecx</a></span><span class="op">(</span><span class="va">exp_5</span>, ecx_val <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">ECx50</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ecx.html">ecx</a></span><span class="op">(</span><span class="va">exp_5</span>, ecx_val <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">ECx10</span></span>
<span><span class="co">#&gt;      Q50     Q2.5    Q97.5 </span></span>
<span><span class="co">#&gt; 3.622077 2.709280 4.157703 </span></span>
<span><span class="co">#&gt; attr(,"precision")</span></span>
<span><span class="co">#&gt; [1] 1000</span></span>
<span><span class="co">#&gt; attr(,"ecx_val")</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; attr(,"toxicity_estimate")</span></span>
<span><span class="co">#&gt; [1] "ecx"</span></span>
<span><span class="va">ECx50</span></span>
<span><span class="co">#&gt;      Q50     Q2.5    Q97.5 </span></span>
<span><span class="co">#&gt; 5.100009 4.832196 5.368070 </span></span>
<span><span class="co">#&gt; attr(,"precision")</span></span>
<span><span class="co">#&gt; [1] 1000</span></span>
<span><span class="co">#&gt; attr(,"ecx_val")</span></span>
<span><span class="co">#&gt; [1] 50</span></span>
<span><span class="co">#&gt; attr(,"toxicity_estimate")</span></span>
<span><span class="co">#&gt; [1] "ecx"</span></span></code></pre></div>
<p>The weighted <em>NEC</em> estimates can be extracted directly from
the <em>NEC</em> model set object, as they are an explicit parameter in
these models.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NECvals</span> <span class="op">&lt;-</span> <span class="va">exp_5_nec</span><span class="op">$</span><span class="va">w_nec</span></span>
<span><span class="va">NECvals</span></span>
<span><span class="co">#&gt; Estimate     Q2.5    Q97.5 </span></span>
<span><span class="co">#&gt; 3.558723 3.153759 4.024148</span></span></code></pre></div>
<p>Note that the new <em>NEC</em> estimates from the
<strong>nec</strong>-containing model fits are slightly higher than
those reported in the summary output of all the fitted models. This can
happen for smooth curves, which is what was used as the underlying data
generation model in the simulations here, and is explored in more detail
in the <a href="https://open-aims.github.io/bayesnec/articles/example4.html" class="external-link">Compare
posteriors vigenette</a>.</p>
</div>
<div class="section level4">
<h4 id="putting-it-all-together">Putting it all together<a class="anchor" aria-label="anchor" href="#putting-it-all-together"></a>
</h4>
<p>Now we can make a combined plot of our output, showing the model
averaged <em>NEC</em> model and the “all averaged model”, along with the
relevant thresholds.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="va">exp_5_nec</span><span class="op">$</span><span class="va">w_pred_vals</span><span class="op">$</span><span class="va">data</span></span>
<span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">exp_5</span>, nec <span class="op">=</span> <span class="cn">FALSE</span>, all <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">ECx10</span>, colour <span class="op">=</span> <span class="st">"ECx 10"</span><span class="op">)</span>,</span>
<span>             linetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, key_glyph <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">ECx50</span>, colour <span class="op">=</span> <span class="st">"ECx 50"</span><span class="op">)</span>,</span>
<span>             linetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, key_glyph <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">NECvals</span>, colour <span class="op">=</span> <span class="st">"NEC"</span><span class="op">)</span>,</span>
<span>             linetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, key_glyph <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ECx 10"</span> <span class="op">=</span> <span class="st">"orange"</span>, <span class="st">"ECx 50"</span> <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>                                <span class="st">"NEC"</span> <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">preds</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">Estimate</span><span class="op">)</span>,</span>
<span>            colour <span class="op">=</span> <span class="st">"tomato"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">preds</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">Q2.5</span><span class="op">)</span>,</span>
<span>            colour <span class="op">=</span> <span class="st">"tomato"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">preds</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">Q97.5</span><span class="op">)</span>,</span>
<span>            colour <span class="op">=</span> <span class="st">"tomato"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>        strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="vignette-fig-exmp2-pretty-1.png" alt="plot of chunk exmp2-pretty" width="60%"><p class="caption">
plot of chunk exmp2-pretty
</p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Burnham2002" class="csl-entry">
Burnham, K P, and D R Anderson. 2002. <em><span class="nocase">Model
Selection and Multimodel Inference; A Practical Information-Theoretic
Approach</span></em>. 2nd ed. New York: Springer.
</div>
<div id="ref-fisherfox2023" class="csl-entry">
Fisher, Rebecca, and David R. Fox. n.d. <span>“Introducing the
No-Significant-Effect Concentration.”</span> <em>Environmental
Toxicology and Chemistry</em> n/a (n/a). https://doi.org/<a href="https://doi.org/10.1002/etc.5610" class="external-link">https://doi.org/10.1002/etc.5610</a>.
</div>
<div id="ref-Thorley2018" class="csl-entry">
Thorley, Joe, and Carl Schwarz. 2018. <em><span class="nocase">ssdtools:
Species Sensitivity Distributions</span></em>. <a href="https://CRAN.R-project.org/package=ssdtools" class="external-link">https://CRAN.R-project.org/package=ssdtools</a>.
</div>
<div id="ref-vehtari2020" class="csl-entry">
Vehtari, Aki, Jonah Gabry, Mans Magnusson, Yuling Yao, Paul-Christian
Bürkner, Topi Paananen, and Andrew Gelman. 2020. <em>Loo: Efficient
Leave-One-Out Cross-Validation and WAIC for Bayesian Models</em>. <a href="https://mc-stan.org/loo/" class="external-link">https://mc-stan.org/loo/</a>.
</div>
<div id="ref-vehtari2017" class="csl-entry">
Vehtari, Aki, Andrew Gelman, and Jonah Gabry. 2017. <span>“Practical
Bayesian Model Evaluation Using Leave-One-Out Cross-Validation and
WAIC.”</span> <em>Statistics and Computing</em> 27: 1413–32. <a href="https://doi.org/10.1007/s11222-016-9696-4" class="external-link">https://doi.org/10.1007/s11222-016-9696-4</a>.
</div>
<div id="ref-Yao2018" class="csl-entry">
Yao, Yuling, Aki Vehtari, Daniel Simpson, and Andrew Gelman. 2018.
<span>“<span class="nocase">Using Stacking to Average Bayesian
Predictive Distributions (with Discussion)</span>.”</span> <em>Bayesian
Analysis</em> 13: 917–1007.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rebecca Fisher, Diego Barneche, Gerard Ricardo, David Fox.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
