---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bayesnec.bib
---

```{r setup, include = FALSE}
stopifnot(require(knitr))
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r echo = FALSE}
e1 <- "https://open-aims.github.io/bayesnec/articles/example1.html"
e2 <- "https://open-aims.github.io/bayesnec/articles/example2.html"
e2b <- "https://open-aims.github.io/bayesnec/articles/example2b.html"
e3 <- "https://open-aims.github.io/bayesnec/articles/example3.html"
e4 <- "https://open-aims.github.io/bayesnec/articles/example4.html"
```

[e1]: `r e1`
[e2]: `r e2`
[e2b]: `r e2b`
[e3]: `r e3`
[e4]: `r e4`

# `bayesnec`

The `bayesnec` is an R package to fit concentration(dose) — response curves to toxicity data, and derive No-Effect-Concentration (*NEC*), No-Significant-Effect-Concentration (*NSEC*), and Effect-Concentration (of specified percentage 'x', *ECx*) thresholds from non-linear models fitted using Bayesian MCMC fitting methods via `brms` [@Burkner2017; @Burkner2018] and `stan`. The package is an adaptation and extension of an initial package `jagsNEC` [@Fisher2020] which was based on the `R2jags` package [@Su2015] and `jags` [@Plummer2003].

# Background

Bayesian model fitting can be difficult to automate across a broad range of usage cases, particularly with respect to specifying valid initial values and appropriate priors. This is one reason the use of Bayesian statistics for *NEC* estimation (or even *ECx* estimation) is not currently widely adopted across the broader ecotoxicological community, who may not have access to specialist statistical expertise. The `bayesnec` package provides an accessible interface specifically for fitting *NEC* models and other concentration—response models using Bayesian methods. A range of models are specified based on the assumeddistribution of the "concentration" the "response" (y) variable. The model formula, including priors and initial values required to call a `brms` model are automatically generated based on information contained in the supplied data. While the distribution of the y variable can be specified directly, `bayesnec` will automatically 'guess' the correct distribution to use based on the characteristics of the provided data.

This project started with an implementation of the *NEC* model based on that described in (Pires et al. 2002) and [@Fox2010] using R2jags [@Fisher2020]. The package has been further generalised to allow a large range of response variables to be modelled using the appropriate statistical distribution. While the original `jagsNEC` implementation supported Gaussian, Poisson, Binomial, Gamma, Negative Binomial and beta response data `bayesnec` additionally supports the Beta-Binomial distribution, and can be easily extended to include any of the available `brms` families. We have since also further added a range of alternative *NEC* model types, as well as a range of  concentration—response models (such as 4-parameter logistic and Weibull models) that are commonly used in frequentist packages such as `drc`[@Ritz2016]. These models do not employ segmented regression (i.e., use of a ‘step’ function) but simply model the response as a smooth function of concentration.  

Important information on the current package is contained in the `bayesnec` help-files and the package vignettes.

This package is currently under development. We are keen to receive any feedback regarding usage, and especially bug reporting that includes an easy to run self-contained reproducible example of unexpected behaviour, or example model fits that fail to converge (have poor chain mixing) or yield other errors. Such information will hopefully help us towards building a more robust package. We cannot help troubleshoot issues if an easy-to-run reproducible example is not supplied.

# Technical details and Usage

## Installation

To install the latest version from GitHub (https://github.com/open-AIMS/bayesnec) use:

```{r, eval = FALSE}
install.packages("remotes")
remotes::install_github("open-AIMS/bayesnec")
```

To run this vignette, we will also need some additional packages, which are made available via `tidyverse`

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "hide"}
install.packages("tidyverse", repos = "http://cran.us.r-project.org")
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
```

## Model specification

The main working function in `bayesnec` is `bnec`. We have attempted to make the `bnec` function as easy to use as possible, targeting the novice R user. A `bayesnec` model can be fit as simply as:

```{r fit, eval=FALSE}
library(bayesnec)
data(nec_data)
exmp_fit <- bnec(data = nec_data, x_var = "x", y_var = "y", model = "all")
```

Only three arguments must be supplied, including: `data`---a `data.frame` containing the data to use for the model; `x_var`---a `character` indicating the column heading containing the concentration (x) variable; and `y_var`---a `character` indicating the column heading containing the response (y) variable. The next argument `model` is a `character` indicating the desired model (or model-set, see details below) and currently defaults to "all" models available. A large range of arguments to be passed to `brms` or model weighting via `loo` can be specified manually by the user as required for more advanced users.

While the statistical distribution of the response variable (y) can be specified directly, `bayesnec` will automatically try and predict the most appropriate distribution (family) to use based on the characteristics of the provided data, as well as build the relevant model priors (see more details below) and initial values for the `brms` model. Initial values are selected such that they yield predicted values in the range of the observed response (`y_var`) data.

If not supplied, the appropriate family to use will be determined based on the characteristics of the input data. This includes evaluation of class (integer or numeric) as well as the observed range via the function `check_data`. Family predictions include all of the available families (see above) except negative binomial and beta-binomial because these require knowledge on whether the data are overdispersed, which are not assessed prior to model fitting. By default `bayesnec` will use the default link function for the predicted family. Note that in `bnec` the default link for the gamma family has been set to `log`. If other link functions are required for any of the implemented families, such as `identity` in the case of a beta family for example, this will need to be specified manually using:

```{r, eval=FALSE}
family = Beta(link = "identity")
```

Data that are numeric and scaled from `0` to `1` or `0` to `Inf` are assumed to be `beta` and `gamma` distributed respectively. Because both distributions are naturally truncated at `0`, if necessary a value that is `0` is increased by 1/10th of the next smallest non-zero value. Similarly, because `beta` is also truncated at `1`, ones are substituted with 0.999. Data scaled from or `-Inf` to `Inf` are modelled using a `gaussian` distribution.

If `y_var` data are integers and a `trials_var` argument is supplied (must also be integer) a `binomial` distribution is assumed. If no `trials_var` argument is supplied the `y_var` data are assumed to be `poisson`. Similar checks are used to assign a likely family to the `x_var` (concentration) data. In this case of `x_var` data, the assigned family only influences the priors on `x_var`-based model parameters (*NEC*), which can be overridden by setting manual priors (see more information on priors below).

Specific models can be fit directly using `bnec`, in which case an object of class `bayesnecfit` is returned. `bayesnec` includes a set of `bayesnecfit` methods for predicting, plotting and extracting effect concentrations and related threshold values. Alternatively it is possible to fit a custom model-set, specific model-set or all of the available models. The default in `bayesnec` is to use `model = "all"` which fits all of the available models.

When multiple models are fitted using `bnec`, an object of class `bayesmanecfit` is returned that includes a model weighted estimate of predicted posterior values. `bayesnec` also includes a set of `bayesmanecfit` methods for predicting, plotting and extracting effect concentrations and related threshold values that return model weighted estimates. 

Multi-model inference can be useful where there are a range of plausible models that could be used [@Burnham2002] and has been recently adopted in ecotoxicology for Species Sensitivity Distribution (SSD) model inference [@Thorley2018; @fox2020; @Dalgarno]. The approach may have considerable value in C-R modelling because there is often no a priori knowledge of the functional form that the response relationship should take. In this case model averaging can be a useful way of allowing the data to drive the model selection process, with weights proportional to how well the individual models fit the data. Well-fitting models will have high weights, dominating the model averaged outcome. Conversely, poorly fitting models will have very low model weights and will therefore have little influence on the outcome. Where multiple models fit the data equally well, these can equally influence the outcome, and the resultant posterior predictions reflect that model uncertainty. It is possible to specify the "stacking" method [@Yao2018] for model weights if desired (through the argument `loo_controls`) which aims to minimise prediction error. We do not currently recommend using stacking weights given the typical sample sizes associated with most C-R experiments, and because the main motivation for model averaging within the `bayesnec` package is to properly capture model uncertainty rather than reduce prediction error. By default `bayesnec` uses the  "pseudobma" method using the Bayesian bootstrap through `loo_model_weights` [@vehtari2020; @vehtari2017]. These are reasonably analogous to the way model weights are generated using AIC or AICc [@Burnham2002].

