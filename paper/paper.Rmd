---
title: 'bayesnec: An R package for C-R modelling and estimation of No-Effect-Concentrations'
tags:
  - R
  - C-R
  - ecotoxicology
  - effect concentration
  - threshold derivation
  - nec
authors:
  - name: Rebecca Fisher
    orcid: 0000-0001-5148-6731
    affiliation: "1, 2"
  - name: Diego Barneche
    orcid: 0000-0002-4568-2362
    affiliation: "1, 2"
  - name: Gerard Ricardo
    orcid: 0000-0002-7761-0806
    affiliation: "1"
  - name: David Fox
    orcid: 0000-0002-3178-7243
    affiliation: "3, 4"
  
  
affiliations:
 - name: Australian Institute of Marine Science, Australia
   index: 1
 - name: The Indian Ocean Marine Research Centre, University of Western Australia, Australia
   index: 2
 - name: Environmetrics Australia, Beaumaris, Victoria, Australia
   index: 3
 - name: University of Melbourne, Parkville, Victoria, Australia
   index: 4

citation_author: Fisher et al.
date: "`r Sys.Date()`"
bibliography: paper.bib
output:
 my_modified_joss:
   fig_caption: yes
csl: apa.csl
journal: JOSS
---

# Summary

The `bayesnec` package in R has been developed to fit concentration(dose) - response curves (C-R) to toxicity data for the purpose of deriving No-Effect-Concentration (*NEC*), No-Significant-Effect-Concentration (*NSEC*), and Effect-Concentration (of specified percentage 'x', *ECx*) thresholds from non-linear models fitted using Bayesian MCMC fitting methods via `brms` [@Burkner2017; @Burkner2018] and `stan` [@rstan2020]. The package is an adaptation and extension of an initial package `jagsNEC` [@Fisher2020] which was based on the `R2jags` package [@Su2015] and `jags` [@Plummer2003]. In `bayesnec` it is possible to fit a single model, custom model-set, specific model-set or all of the available models. When multiple models are specified the `bnec` function returns a model weighted average estimate of predicted posterior values. A range of support functions and methods are also included to work with the returned single, or multi- model objects that allow extraction of raw, or model averaged predicted, *ECx*, *NEC* and *NSEC* values and to interrogate the fitted model or model-set. The statistical methods used mean that the uncertainty in derived threshold values can be robustly quantified, including uncertainty in individual model fits to the underlying observed data, as well as uncertainty in the model functional form.

# Statement of need

Concentration-response (C-R) modelling is fundamental to assessing toxicity and deriving toxicity thresholds used in the risk assessments that underpin protection of human health and the environment. It is widely used in the disciplines of pharmacology, toxicology and ecotoxicology. Typically C-R curves are non-linear, which increases the complexity of model fitting. Estimates of uncertainty in parameters and derived thresholds are critical to effective integration in risk assessment and formal decision frameworks. Bayesian methods that allow robust quantification of uncertainty with intuitive and direct probabilistic meaning [@Ellison1996] and are therefore an ideal platform for C-R modelling in most settings.

Bayesian model fitting can be difficult to automate across a broad range of usage cases, particularly with respect to specifying valid initial parameter values and appropriate priors. This is one reason the use of Bayesian statistics for *NEC* estimation (or even *ECx* estimation) is not currently widely adopted across the broader ecotoxicology and toxicology communities, who may not have access to specialist statistical expertise. The `bayesnec` package provides an accessible interface specifically for fitting *NEC* and other C-R models using Bayesian methods. A range of models can be specified based on the known distribution of the "concentration" or "dose" variable (the predictor, x) as well as the "response" (y) variable. The model formula, including priors and initial values required to call `brms` are automatically generated based on information contained in the supplied data.

# Technical details

This project started with an implementation of the *NEC* model based on that described in [@Fox2010; @Pires2002] using R2jags [@Su2015]. Code for fitting this initial model was developed into the R package `jagsNEC` and  expanded to include several C-R models and further generalised to allow a large range of response variables to be modelled using their appropriate statistical distribution. While the original `jagsNEC` implementation supported gaussian, poisson, binomial, gamma, negative binomial and beta response data, `bayesnec` supports all of these in addition to the beta binomial family. Furthermore, the new structure implemented using `brms` means `bayesnec` can be readily extended to include any of the `brms` families. In addition to greater flexibility in the available response families, `bayesnec` includes a larger range of alternative *NEC* model types, as well as most typically used smooth C-R models (such as 4-parameter logistic and weibull models) that have no *NEC* 'step' function but simply model the response as a smooth function of concentration. We have now incorporated most of the commonly used models in frequentist packages such as `drc` [@Ritz2016] (please see the [Model details](https://open-aims.github.io/bayesnec/articles/example2b.html) vignette for more information on the full list of models currently available in `bayesnec`).

Model specification has been made a simple as possible, targeting the novice R user. However a large range of arguments can be passed to `brms`, or model weighting via `loo` can be specified manually by the user as required for more advanced users. While the statistical distribution of the response variable (y) can be specified directly, `bayesnec` will automatically try and predict the most appropriate distribution (family) to use based on the characteristics of the provided data, as well as build the relevant model priors (see more details below) and initial values for the `brms` model. Initial values are selected such that they yield predicted values in the range of the observed response (`y_var`) data.

Specific models can be fit directly using `bnec`, in which case an object of class `bayesnecfit` is returned, otherwise if multiple models are fit an object of class `bayesmanecfit` is returned that includes a model weighted estimate of predicted posterior values. `bayesnec` also includes a set of `bayesmanecfit` methods for predicting, plotting and extracting effect concentrations and related threshold values that return model weighted estimates. 

Multi-model inference can be useful where there are a range of plausible models that could be used [@Burnham2002] and has been recently adopted in ecotoxicology for Species Sensitivity Distribution (SSD) model inference [@Thorley2018; @fox2020; @Dalgarno]. The approach may have considerable value in C-R modelling because there is often no a priori knowledge of the functional form that the response relationship should take. In this case model averaging can be a useful way of allowing the data to drive the model selection process, with weights proportional to how well the individual models fit the data. Well-fitting models will have high weights, dominating the model averaged outcome. Conversely, poorly fitting models will have very low model weights and will therefore have little influence on the outcome. Where multiple models fit the data equally well, these can equally influence the outcome, and the resultant posterior predictions reflect that model uncertainty.


ll diagnostic functions available in `brms` and `rstan` can be used on the underlying `brm` model fit by extracting the fitted `brms` model from the `bayenecfit` or `bayesmanecfit` model object. In addition we have implemented a range of tools for assessing model fit, a summary method, Base R (`plot`) and ggplot2 (`ggbnec`) plotting methods, as well as predict methods for both `bayesnecfit` and `bayesmanecfit` model classes. Several helper functions have been also included that allow the user to add or drop models from a `bayesmanecfit` object, or change the model weighting method; extract a single or subset of models from the `bayesmanecfit` object and examine the priors used for model fitting. In addition, there are method-based functions for extracting *ECx* (`ecx`), *NEC* (`nec`) and *NSEC* (`nsec`) threshold values.

## Models in `bayesnec`

A wide range of models have been implemented in `bayesnec` and the models available are being regularly expanded. Please see the [Model details](https://open-aims.github.io/bayesnec/articles/example2b.html) vignette or `?model("all")` for more information on all the models available in `bayesnec` and their specific formulation. Some models are not suitable for a given response family (please see the [Intorduction](https://open-aims.github.io/bayesnec/articles/example0.html) vignette for more detail)and  `bayesnec` will automatically exclude inappropriate models with a warning. Where possible we have aimed for consistency in the interpretable meaning of the individual parameters across models. All models provide an estimate of the No-Effect-Concentration (*NEC*). For model types with "nec" as a prefix, the *NEC* is directly estimated as parameter $\eta = \text{NEC}$ in the model, as per @Fox2010. Models with "ecx" as a prefix are continuous curve models, typically used for extracting *ECx* values from C-R data. In this instance the *NEC* reported is actually the No-Significant-Effect-Concentration (*NSEC*, see `?nsec` for more details). We currently recommend only using the "nec" model-set for estimation of *NEC* values, as the *NSEC* concept has yet to be formally peer-reviewed, and likely suffers from at least some of the same issues as the No-Observed-Effect-Concentration [@Warne2008a; @Fox2008].

*ECx* estimates can be equally validly obtained from both "nec" and "ecx" models. *ECx* estimates will usually be lower (more conservative) for "ecx" models fitted to the same data as "nec" models (see the [Comparing posterior predictions](https://open-aims.github.io/bayesnec/articles/example4.html) vignette for an example. However, we recommend using "all" models where *ECx* estimation is required because "nec" models can fit some datasets better than "ecx" models and the model averaging approach will place the greatest weight for the outcome that best fits the supplied data. This approach will yield *ECx* estimates that are the most representative of the underlying relationship in the dataset.

There is ambiguity in the definition of *ECx* estimates from hormesis models (these allow an initial increase in the response [see @Mattson2008] and include models with the character string `horme` in their name), as well as those that have no natural lower bound on the scale of the response (models with the string `lin` in their name, in the case of gaussian response data). In both cases the relevant functions `bayesnec` have arguments to handle this explicitly and the user shoudl carefully review the relevant documentation.

## Priors on model parameters

In Bayesian inference, model parameters and their inherent uncertainty are estimated as statistical probability distributions. This is achieved by combining an a-prior understanding of each parameter's probability density function (the 'priors') with the likelihood of the observed information (data) given the model parameters, to yield a so-called posterior probability distribution. Regardless of whether this is done mathematically via Bayes' theorem or through monte-carlo simulation, to carry out a Bayesian analysis the prior probability densities must be defined. Sometimes there may be substantial prior knowledge, for example when pilot data or data from a previous experiment exist for a given response curve. In this case the prior probability distribution may be quite narrow (highly "informative") and can have a strong influence on the posterior, especially when subsequent data are scarce or highly variable. In our experience however, such prior knowledge is generally the exception. Where no quantitative prior information exists, it is common in Bayesian statistics to use "vague" or "weakly" informative priors. The use of "vague", "diffuse", "flat" or otherwise so-called "uninformative" priors is no longer recommended [@Banner2020]. Such priors generally form the default for many Bayesian packages, and are often used in practice without critical thought or evaluation, possibly as a result of fear of being too 'subjective' [@Banner2020]. 

Considerable thought has gone into development of an algorithm to build "weakly" informative priors for fitting models in `bayesnec`, as this is one of the most critical elements of Bayesian model fitting (and the biggest deviation from frequentist approaches). The priors are "weakly" informative in that in addition to specifying the relevant statistical family that appropriately captures the parameters likely theoretical statistical distribution, we also use information contained within the observed data to centre the probability density near the most likely parameter space and/or constrain priors to sensible bounds. These weakly informative priors are used to help constrain the underlying routines so that they are less likely to consider what the researcher would deem highly improbable estimates, that also cause the routines to become unstable. Weakly informative priors can be particularly helpful in complex non-linear modelling to ensure reliable convergence. These types of priors specify the general shape and bounds of the expected probability distribution for a given parameter, whilst remaining sufficiently broad so as not to influence the parameter's estimated posterior distribution (given a reasonable amount of observed data). In this sense appropriately weak priors should yield analytical outcomes that share the same level of *objectivity* as equivalent frequentist approaches, whilst yielding robust parameter estimates with probabilistically interpretable uncertainty bounds. Helper functions are provided for the user to interrogate priors to ensure they are sensible and are not exerting an undesirable influence over the analysis, and they can also be readily modified by the user (see the [Priors](https://open-aims.github.io/bayesnec/articles/example3.html) vignette for further details).

# Acknowledgements

The development of `bayesnec` was supported by an AIMS internal grant. David Fox and Gerard Ricardo developed some of the initial code on which the `bayesnec` predecessor `jagsNEC` was based. Usage, testing and functionality of both the `jagsNEC` and `bayesnec` packages were substantially aided through input from Joost van Dam, Andrew Negri, Florita Flores, Heidi Luter, Marie Thomas and Mikaela Nordborg. Florita Flores and Murray Logan provided valuable comments on the manuscript text. Ron Jones resolved issues with the paper.bib file that was causing compilation to fail. 


# References
